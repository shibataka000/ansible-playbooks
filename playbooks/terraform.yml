- hosts: all
  become: yes
  vars:
    - release_id: latest
  tasks:
    - name: "Install unzip"
      apt:
        name: unzip
    - name: "Download release info"
      get_url:
        url: https://api.github.com/repos/hashicorp/terraform/releases/{{ release_id }}
        dest: "/tmp/terraform.json"
        force: yes
    - name: "Get release info"
      shell: "cat /tmp/terraform.json"
      register: releases
    - name: "Get version"
      set_fact:
        version: "{{ (releases.stdout | from_json).tag_name | regex_replace('v', '')}}"
    - name: "Download terraform"
      get_url:
        url: https://releases.hashicorp.com/terraform/{{ version }}/terraform_{{ version }}_linux_amd64.zip
        dest: /tmp/terraform.zip
        force: yes
    - name: "Unarchive terraform"
      unarchive:
        src: /tmp/terraform.zip
        dest: /usr/local/bin
        remote_src: yes
    - name: "Make sure installed"
      shell: "terraform version"
